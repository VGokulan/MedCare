{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Patient Data - Medical Dashboard</title>
    <!-- Links to the main dashboard style and the new upload-specific style -->
    <link
      rel="stylesheet"
      href="{% static 'pages/css/dashboard_style.css' %}"
    />
    <link rel="stylesheet" href="{% static 'pages/css/upload_style.css' %}" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Top Header (from base.html) -->
      <header class="header">
        <div class="header-left">
          <div class="logo"><span class="logo-text">PRD</span></div>
        </div>
        <div class="header-center"><h1>Upload Patient Data</h1></div>
        <div class="header-right">
          <div class="theme-toggle">
            <i class="fas fa-sun"></i>
            <div class="toggle-switch" id="themeToggle">
              <div class="toggle-slider"></div>
            </div>
            <i class="fas fa-moon"></i>
          </div>
          <div class="user-profile">
            <span class="user-name"
              >{{ user.first_name|default:user.email }}</span
            ><span class="user-status">Online</span>
            <div class="user-avatar"></div>
          </div>
        </div>
      </header>

      <!-- Main Content (from base.html) -->
      <div class="main-content">
        <!-- Sidebar (with 'Upload Data' now active) -->
        <aside class="sidebar">
          <nav class="sidebar-nav">
            <a href="{% url 'admin_dashboard' %}" class="nav-item"
              ><i class="fas fa-users"></i><span>Patients List</span></a
            >
            <a href="{% url 'upload_data' %}" class="nav-item active"
              ><i class="fas fa-plus"></i><span>Upload Data</span></a
            >
            <a href="{% url 'logout' %}" class="nav-item"
              ><i class="fas fa-sign-out-alt"></i><span>Logout</span></a
            >
          </nav>
        </aside>

        <!-- Content Area, filled with your upload form -->
        <div class="content">
          <div class="upload-header">
            <div class="upload-title">
              <h1>Medicare Risk Prediction</h1>
              <p>
                Enter patient information to predict hospitalization and
                mortality risk
              </p>
            </div>
            <div class="upload-actions">
              <button class="btn-secondary" onclick="resetForm()">
                <i class="fas fa-undo"></i> Reset Form
              </button>
              <button class="btn-primary" type="submit" form="patientForm">
                <i class="fas fa-calculator"></i> Predict Risk
              </button>
            </div>
          </div>

          <!-- Upload Form -->
          <form
            id="patientForm"
            class="upload-form"
            method="POST"
            action="{% url 'upload_data' %}"
          >
            {% csrf_token %}
            <!-- Basic Information Section -->
            <div class="form-section">
              <h2><i class="fas fa-user"></i> Basic Information</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="patientId">Patient ID *</label
                  ><input
                    type="text"
                    id="patientId"
                    name="DESYNPUF_ID"
                    required
                    placeholder="Enter patient ID"
                  />
                </div>
                <div class="form-group">
                  <label for="patientName">Patient Name *</label
                  ><input
                    type="text"
                    id="patientName"
                    name="name"
                    required
                    placeholder="Enter patient name"
                  />
                </div>
                <div class="form-group">
                  <label for="age">Age *</label
                  ><input
                    type="number"
                    id="age"
                    name="age"
                    min="18"
                    max="120"
                    required
                    placeholder="Enter age"
                  />
                </div>
                <div class="form-group">
                  <label for="gender">Gender *</label
                  ><select id="gender" name="gender_male" required>
                    <option value="">Select gender</option>
                    <option value="1">Male</option>
                    <option value="0">Female</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Race Information Section -->
            <div class="form-section">
              <h2><i class="fas fa-globe"></i> Race Information</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="raceWhite">White</label
                  ><select id="raceWhite" name="race_white">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="raceBlack">Black</label
                  ><select id="raceBlack" name="race_black">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Chronic Conditions Section -->
            <div class="form-section">
              <h2><i class="fas fa-heartbeat"></i> Chronic Conditions</h2>
              <h3>Specific Conditions (Select all that apply)</h3>
              <!-- THIS IS THE CORRECTED, COMPLETE LIST -->
              <div class="conditions-grid">
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="chf"
                    name="SP_CHF"
                    value="1"
                  /><label for="chf">Congestive Heart Failure (CHF)</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="diabetes"
                    name="SP_DIABETES"
                    value="1"
                  /><label for="diabetes">Diabetes</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="kidney"
                    name="SP_CHRNKIDN"
                    value="1"
                  /><label for="kidney">Chronic Kidney Disease</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="cancer"
                    name="SP_CNCR"
                    value="1"
                  /><label for="cancer">Cancer</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="copd"
                    name="SP_COPD"
                    value="1"
                  /><label for="copd">COPD</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="depression"
                    name="SP_DEPRESSN"
                    value="1"
                  /><label for="depression">Depression</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="heartDisease"
                    name="SP_ISCHMCHT"
                    value="1"
                  /><label for="heartDisease">Ischemic Heart Disease</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="stroke"
                    name="SP_STRKETIA"
                    value="1"
                  /><label for="stroke">Stroke</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="alzheimers"
                    name="SP_ALZHDMTA"
                    value="1"
                  /><label for="alzheimers">Alzheimer's/Dementia</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="osteoporosis"
                    name="SP_OSTEOPRS"
                    value="1"
                  /><label for="osteoporosis">Osteoporosis</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="arthritis"
                    name="SP_RA_OA"
                    value="1"
                  /><label for="arthritis"
                    >Rheumatoid Arthritis/Osteoarthritis</label
                  >
                </div>
              </div>
            </div>

            <!-- Healthcare Utilization Section -->
            <div class="form-section">
              <h2><i class="fas fa-hospital"></i> Healthcare Utilization</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="inpatientAdmissions">Inpatient Admissions *</label
                  ><input
                    type="number"
                    id="inpatientAdmissions"
                    name="inpatient_admissions"
                    min="0"
                    required
                    placeholder="Enter count"
                  />
                </div>
                <div class="form-group">
                  <label for="inpatientDays">Inpatient Days *</label
                  ><input
                    type="number"
                    id="inpatientDays"
                    name="inpatient_days"
                    min="0"
                    required
                    placeholder="Enter days"
                  />
                </div>
                <div class="form-group">
                  <label for="outpatientVisits">Outpatient Visits *</label
                  ><input
                    type="number"
                    id="outpatientVisits"
                    name="outpatient_visits"
                    min="0"
                    required
                    placeholder="Enter count"
                  />
                </div>
                <div class="form-group">
                  <label for="totalCosts">Total Medicare Costs ($) *</label
                  ><input
                    type="number"
                    id="totalCosts"
                    name="total_medicare_costs"
                    min="0"
                    step="0.01"
                    required
                    placeholder="Enter amount"
                  />
                </div>
                <div class="form-group">
                  <label for="priorHospitalization">Prior Hospitalization</label
                  ><select
                    id="priorHospitalization"
                    name="prior_hospitalization"
                  >
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                  </select>
                </div>
              </div>
            </div>
          </form>

          <!-- Results Section (Hidden by default) -->
          <div
            id="resultsSection"
            class="results-section"
            style="display: none"
          >
            <!-- Results display structure -->
          </div>

          <!-- Loading Indicator -->
          <div
            id="loadingIndicator"
            class="loading-indicator"
            style="display: none"
          >
            <div class="loading-spinner"></div>
            <p>Processing prediction...</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function submitForm(event) {
        event.preventDefault();

        const form = document.getElementById("patientForm");
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        // Show loading indicator
        document.getElementById("loadingIndicator").style.display = "flex";
        document.getElementById("resultsSection").style.display = "none";

        try {
          // Calculate derived fields
          calculateDerivedFields();

          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());

          const response = await fetch("/upload", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams(data),
          });

          const results = await response.json();

          if (response.ok) {
            showResults(results);
            showNotification("Prediction completed successfully!", "success");
          } else {
            throw new Error(results.error || "Prediction failed");
          }
        } catch (error) {
          showNotification(error.message, "error");
        } finally {
          document.getElementById("loadingIndicator").style.display = "none";
        }
      }

      function calculateDerivedFields() {
        const age = parseInt(document.getElementById("age").value) || 0;
        const outpatientVisits =
          parseInt(document.getElementById("outpatientVisits").value) || 0;
        const totalCosts =
          parseFloat(document.getElementById("totalCosts").value) || 0;

        // Age categories
        document.querySelector('input[name="age_65_74"]').value =
          65 <= age && age <= 74 ? 1 : 0;
        document.querySelector('input[name="age_75_84"]').value =
          75 <= age && age <= 84 ? 1 : 0;
        document.querySelector('input[name="age_85_plus"]').value =
          age >= 85 ? 1 : 0;

        // Race other
        const raceWhite =
          parseInt(document.getElementById("raceWhite").value) || 0;
        const raceBlack =
          parseInt(document.getElementById("raceBlack").value) || 0;
        document.querySelector('input[name="race_other"]').value =
          raceWhite === 0 && raceBlack === 0 ? 1 : 0;

        // Frequent ED user
        document.querySelector('input[name="frequent_ed_user"]').value =
          outpatientVisits > 10 ? 1 : 0;

        // High cost patient
        document.querySelector('input[name="high_cost_patient"]').value =
          totalCosts > 15000 ? 1 : 0;

        // Reimbursement estimates
        const inpatientDays =
          parseInt(document.getElementById("inpatientDays").value) || 0;
        document.querySelector('input[name="MEDREIMB_IP"]').value =
          inpatientDays * 1000;
        document.querySelector('input[name="MEDREIMB_OP"]').value =
          totalCosts * 0.4;
        document.querySelector('input[name="MEDREIMB_CAR"]').value =
          totalCosts * 0.3;
      }

      function showResults(results) {
        // Update UI with actual results from server
        document.getElementById(
          "riskTier"
        ).innerHTML = `<span class="risk-label tier-${results.risk_tier}">${results.risk_tier_label}</span>`;
        document.getElementById("risk30d").textContent = `${(
          results.risk_30d_hospitalization * 100
        ).toFixed(1)}%`;
        document.getElementById("risk60d").textContent = `${(
          results.risk_60d_hospitalization * 100
        ).toFixed(1)}%`;
        document.getElementById("risk90d").textContent = `${(
          results.risk_90d_hospitalization * 100
        ).toFixed(1)}%`;
        document.getElementById("mortalityRisk").textContent = `${(
          results.mortality_risk * 100
        ).toFixed(1)}%`;
        document.getElementById("careIntervention").textContent =
          results.care_intervention || "Enhanced Monitoring";
        document.getElementById("interventionCost").textContent = `$${
          results.annual_intervention_cost || 400
        }`;
        document.getElementById("costSavings").textContent = `$${
          results.cost_savings || 1200
        }`;
        document.getElementById("preventedHosp").textContent = (
          results.prevented_hospitalizations || 0.15
        ).toFixed(2);

        // Show results section
        document.getElementById("resultsSection").style.display = "block";
      }

      function resetForm() {
        document.getElementById("patientForm").reset();
        document.getElementById("resultsSection").style.display = "none";
        showNotification("Form reset successfully!", "info");
      }

      function showNotification(message, type = "info") {
        const container = document.getElementById("notificationContainer");
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${
              type === "success"
                ? "check-circle"
                : type === "error"
                ? "exclamation-circle"
                : "info-circle"
            }"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">&times;</button>
        `;

        container.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 5000);
      }

      // Form validation
      document
        .getElementById("patientForm")
        .addEventListener("input", function (e) {
          if (
            e.target.hasAttribute("required") &&
            e.target.value.trim() === ""
          ) {
            e.target.classList.add("invalid");
          } else {
            e.target.classList.remove("invalid");
          }
        });

      // Update button onclick to pass event
      document.querySelector(".btn-primary").onclick = submitForm;
      // Your JavaScript for theme toggling and form submission
      // ...
    </script>
  </body>
</html>
