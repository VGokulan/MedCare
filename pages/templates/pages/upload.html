{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Patient Data - Medical Dashboard</title>
    <!-- Links to the main dashboard style and the new upload-specific style -->
    <link
      rel="stylesheet"
      href="{% static 'pages/css/dashboard_style.css' %}"
    />
    <link rel="stylesheet" href="{% static 'pages/css/upload_style.css' %}" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <div class="logo"><span class="logo-text">PRD</span></div>
        </div>
        <div class="header-center"><h1>Upload Patient Data</h1></div>
        <div class="header-right">
          <div class="theme-toggle">
            <i class="fas fa-sun"></i>
            <div class="toggle-switch" id="themeToggle">
              <div class="toggle-slider"></div>
            </div>
            <i class="fas fa-moon"></i>
          </div>
          <div class="user-profile">
            <span class="user-name"
              >{{ user.first_name|default:user.email }}</span
            ><span class="user-status">Online</span>
            <div class="user-avatar"></div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Sidebar (with 'Upload Data' now active) -->
        <aside class="sidebar">
          <nav class="sidebar-nav">
            <a href="{% url 'admin_dashboard' %}" class="nav-item"
              ><i class="fas fa-users"></i><span>Patients List</span></a
            >
            <a href="{% url 'upload_data' %}" class="nav-item active"
              ><i class="fas fa-plus"></i><span>Upload Data</span></a
            >
            <a href="{% url 'logout' %}" class="nav-item"
              ><i class="fas fa-sign-out-alt"></i><span>Logout</span></a
            >
          </nav>
        </aside>

        <!-- Content Area, filled with your upload form -->
        <div class="content">
          <div class="upload-header">
            <div class="upload-title">
              <h1>Medicare Risk Prediction</h1>
              <p>
                Enter patient information to predict hospitalization and
                mortality risk
              </p>
            </div>
            <div class="upload-actions">
              <button class="btn-secondary" onclick="resetForm()">
                <i class="fas fa-undo"></i> Reset Form
              </button>
              <!-- The 'type' is now 'submit' and it's linked to the form -->
              <button class="btn-primary" type="submit" form="patientForm">
                <i class="fas fa-calculator"></i> Predict Risk
              </button>
            </div>
          </div>

          <!-- Upload Form -->
          <form
            id="patientForm"
            class="upload-form"
            method="POST"
            action="{% url 'upload_data' %}"
          >
            {% csrf_token %}
            <!-- Basic Information Section -->
            <div class="form-section">
              <h2><i class="fas fa-user"></i> Basic Information</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="patientId">Patient ID *</label
                  ><input
                    type="text"
                    id="patientId"
                    name="desynpuf_id"
                    required
                    placeholder="Enter patient ID"
                  />
                </div>
                <div class="form-group">
                  <label for="patientName">Patient Name *</label
                  ><input
                    type="text"
                    id="patientName"
                    name="name"
                    required
                    placeholder="Enter patient name (for display)"
                  />
                </div>
                <div class="form-group">
                  <label for="age">Age *</label
                  ><input
                    type="number"
                    id="age"
                    name="age"
                    min="18"
                    max="120"
                    required
                    placeholder="Enter age"
                  />
                </div>
                <div class="form-group">
                  <label for="gender">Gender *</label
                  ><select id="gender" name="gender_male" required>
                    <option value="">Select gender</option>
                    <option value="1">Male</option>
                    <option value="0">Female</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Race Information Section -->
            <div class="form-section">
              <h2><i class="fas fa-globe"></i> Race Information</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="raceWhite">White</label
                  ><select id="raceWhite" name="race_white">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="raceBlack">Black</label
                  ><select id="raceBlack" name="race_black">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Chronic Conditions Section -->
            <div class="form-section">
              <h2><i class="fas fa-heartbeat"></i> Chronic Conditions</h2>
              <div class="conditions-grid">
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="chf"
                    name="sp_chf"
                    value="1"
                  /><label for="chf">CHF</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="diabetes"
                    name="sp_diabetes"
                    value="1"
                  /><label for="diabetes">Diabetes</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="kidney"
                    name="sp_chrnkidn"
                    value="1"
                  /><label for="kidney">Chronic Kidney</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="cancer"
                    name="sp_cncr"
                    value="1"
                  /><label for="cancer">Cancer</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="copd"
                    name="sp_copd"
                    value="1"
                  /><label for="copd">COPD</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="depression"
                    name="sp_depressn"
                    value="1"
                  /><label for="depression">Depression</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="heart"
                    name="sp_ischmcht"
                    value="1"
                  /><label for="heart">Ischemic Heart</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="stroke"
                    name="sp_strketia"
                    value="1"
                  /><label for="stroke">Stroke/TIA</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="alz"
                    name="sp_alzhdmta"
                    value="1"
                  /><label for="alz">Alzheimer's</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="ost"
                    name="sp_osteoprs"
                    value="1"
                  /><label for="ost">Osteoporosis</label>
                </div>
                <div class="condition-item">
                  <input
                    type="checkbox"
                    id="arth"
                    name="sp_ra_oa"
                    value="1"
                  /><label for="arth">RA/OA</label>
                </div>
              </div>
            </div>
            <!-- Healthcare Utilization -->
            <div class="form-section">
              <h2><i class="fas fa-hospital"></i> Healthcare Utilization</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="inpatientAdmissions">Inpatient Admissions *</label
                  ><input
                    type="number"
                    id="inpatientAdmissions"
                    name="inpatient_admissions"
                    min="0"
                    required
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="inpatientDays">Inpatient Days *</label
                  ><input
                    type="number"
                    id="inpatientDays"
                    name="inpatient_days"
                    min="0"
                    required
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="outpatientVisits">Outpatient Visits *</label
                  ><input
                    type="number"
                    id="outpatientVisits"
                    name="outpatient_visits"
                    min="0"
                    required
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="totalCosts">Total Medicare Costs ($) *</label
                  ><input
                    type="number"
                    id="totalCosts"
                    name="total_medicare_costs"
                    min="0"
                    step="0.01"
                    required
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="priorHosp">Prior Hospitalization</label
                  ><select id="priorHosp" name="prior_hospitalization">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                  </select>
                </div>
              </div>
            </div>
          </form>

          <!-- Results Section -->
          <div
            id="resultsSection"
            class="results-section"
            style="display: none"
          >
            <h2><i class="fas fa-chart-line"></i> Prediction Results</h2>
            <div class="results-grid">
              <div class="result-card">
                <h3>Risk Assessment</h3>
                <div class="risk-tier" id="riskTier"></div>
              </div>
              <div class="result-card">
                <h3>30-Day Hosp. Risk</h3>
                <div class="risk-percentage" id="risk30d">--</div>
              </div>
              <div class="result-card">
                <h3>60-Day Hosp. Risk</h3>
                <div class="risk-percentage" id="risk60d">--</div>
              </div>
              <div class="result-card">
                <h3>90-Day Hosp. Risk</h3>
                <div class="risk-percentage" id="risk90d">--</div>
              </div>
              <div class="result-card">
                <h3>Mortality Risk</h3>
                <div class="risk-percentage" id="mortalityRisk">--</div>
              </div>
              <div class="result-card">
                <h3>Care Intervention</h3>
                <div class="intervention-info" id="careIntervention">--</div>
              </div>
            </div>
          </div>

          <!-- Loading Indicator -->
          <div
            id="loadingIndicator"
            class="loading-indicator"
            style="display: none"
          >
            <div class="loading-spinner"></div>
            <p>Processing prediction...</p>
          </div>
          <!-- Notification Container -->
          <div id="notificationContainer" class="notification-container"></div>
        </div>
      </div>
    </div>

    <script>
      // Form submission is now handled by an event listener
      document
        .getElementById("patientForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const form = event.target;
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }

          document.getElementById("loadingIndicator").style.display = "flex";
          document.getElementById("resultsSection").style.display = "none";

          try {
            const formData = new FormData(form);
            const response = await fetch("{% url 'upload_data' %}", {
              method: "POST",
              body: formData,
              headers: { "X-CSRFToken": formData.get("csrfmiddlewaretoken") },
            });

            const results = await response.json();

            if (response.ok) {
              showResults(results);
              showNotification(
                "Prediction completed and data saved!",
                "success"
              );
            } else {
              throw new Error(results.error || "Prediction failed");
            }
          } catch (error) {
            showNotification(error.message, "error");
          } finally {
            document.getElementById("loadingIndicator").style.display = "none";
          }
        });

      function showResults(results) {
        document.getElementById(
          "riskTier"
        ).innerHTML = `<span class="risk-label tier-${results.risk_tier}">${results.risk_tier_label}</span>`;
        document.getElementById("risk30d").textContent = `${(
          results.risk_30d_hospitalization * 100
        ).toFixed(1)}%`;
        document.getElementById("risk60d").textContent = `${(
          results.risk_60d_hospitalization * 100
        ).toFixed(1)}%`;
        document.getElementById("risk90d").textContent = `${(
          results.risk_90d_hospitalization * 100
        ).toFixed(1)}%`;
        document.getElementById("mortalityRisk").textContent = `${(
          results.mortality_risk * 100
        ).toFixed(1)}%`;
        document.getElementById("careIntervention").textContent =
          results.care_intervention || "N/A";
        document.getElementById("resultsSection").style.display = "block";
      }

      function resetForm() {
        document.getElementById("patientForm").reset();
        document.getElementById("resultsSection").style.display = "none";
        showNotification("Form reset.", "info");
      }

      // --- Notification and Theme Toggle ---
      function showNotification(message, type = "info") {
        /* ... (notification logic) ... */
      }
      document.addEventListener("DOMContentLoaded", function () {
        /* ... (theme logic) ... */
      });
    </script>
  </body>
</html>
